# shop_page.py
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª©ì :
#   - ìƒì (Shop) í”„ë¡ íŠ¸ì—”ë“œ í™”ë©´ (Streamlit)
#   - ì„œë²„(FastAPI)ì˜ /shop/purchase ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ì—¬
#     1) í¬ì¸íŠ¸ ì°¨ê°
#     2) ëœë¤ ë°•ìŠ¤ ë³´ìƒ ì§€ê¸‰
#     3) ìµœì¢… í¬ì¸íŠ¸ë¥¼ í™”ë©´ì— í‘œì‹œ
#   - í™”ë©´(UI) ìƒì˜ ë²„íŠ¼/ëª¨ë‹¬/ì•ˆë‚´ ë©”ì‹œì§€ ê´€ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import streamlit as st                # Streamlit UI ë¼ì´ë¸ŒëŸ¬ë¦¬
import requests                      # HTTP ìš”ì²­ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì„œë²„ì™€ í†µì‹ )
from datetime import date            # ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸(í•„ìš” ì‹œ)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„œë²„ ê¸°ë³¸ ì£¼ì†Œ (FastAPI)
#   - ì˜ˆ: http://localhost:8000
#   - ë°°í¬ í™˜ê²½ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜/ì„¤ì • íŒŒì¼ë¡œ ê´€ë¦¬ ê¶Œì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FASTAPI_ENDPOINT = "http://localhost:8000"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ(ì´ˆ) ìƒìˆ˜
#   - ëª¨ë“  requests í˜¸ì¶œì— ë™ì¼í•˜ê²Œ ì‚¬ìš©
#   - ì´ˆë³´ì ì‹¤ìˆ˜ ë°©ì§€: ìˆ«ìë¥¼ ì—¬ê¸°ì„œë§Œ ë°”ê¾¸ë©´ ì „ì²´ì— ë°˜ì˜ë¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TIMEOUT_S = 10

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¸ì…˜ ê¸°ë³¸ê°’ ì„¤ì • í•¨ìˆ˜
#   - st.session_state: í˜ì´ì§€ ê°„/ì»´í¬ë„ŒíŠ¸ ê°„ ê³µìœ ë˜ëŠ” ìƒíƒœ ì €ì¥ì†Œ
#   - í‚¤ê°€ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ê°’ì„ ë„£ìŒ(setdefault)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _ensure_session_defaults():
    s = st.session_state
    s.setdefault("user_id", "")                     # ë¡œê·¸ì¸ í›„ ì±„ì›Œì§(ì´ë©”ì¼/ê³ ìœ ID)
    s.setdefault("points", 0)                       # í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸(ì„œë²„ì™€ ë™ê¸°í™”)
    s.setdefault("last_ad_watch_time", None)        # ê´‘ê³  ë³¸ ë§ˆì§€ë§‰ ì‹œê°(ê¸°ëŠ¥í˜• ì•„ì´í…œ ì—°ë™)
    s.setdefault("ad_cooldown_active", False)       # ê´‘ê³  ì¿¨ë‹¤ìš´ ì—¬ë¶€
    s.setdefault("game_state", "initial")           # ê²Œì„ ìƒíƒœ("initial"/"cooldown" ë“±)
    s.setdefault("game_cooldown_start_time", None)  # ê²Œì„ ì¿¨ë‹¤ìš´ ì‹œì‘ ì‹œê°
    s.setdefault("buying", False)                   # ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸(êµ¬ë§¤ ì¤‘ true)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„œë²„ì—ì„œ ìµœì‹  í¬ì¸íŠ¸ë¥¼ ê°€ì ¸ì™€ ì„¸ì…˜ì— ë°˜ì˜
#   - user_idê°€ ìœ íš¨í•  ë•Œë§Œ ìš”ì²­
#   - ì‹¤íŒ¨í•´ë„ UIëŠ” ê³„ì† ë™ì‘ (í‘œì‹œê°’ë§Œ ì ì‹œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _sync_points_from_server(user_id: str):
    if not user_id:
        return
    try:
        # ì˜ˆì‹œ: /mypage/{user_id}ê°€ total_pointë¥¼ ë‚´ë ¤ì¤€ë‹¤ëŠ” ì „ì œ
        r = requests.get(f"{FASTAPI_ENDPOINT}/mypage/{user_id}", timeout=TIMEOUT_S)
        if r.status_code == 200:
            data = r.json()
            # ì„œë²„ ì„¤ê³„ìƒ "message" í‚¤ê°€ ì˜¤ë¥˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆì–´ ì˜ˆì™¸ ì²˜ë¦¬
            if "message" not in data:
                st.session_state.points = data.get("total_point", st.session_state.points)
    except Exception:
        # ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜/ì„œë²„ ì˜¤ë¥˜ ë“±ì€ ë¬´ì‹œí•˜ê³  ë„˜ì–´ê°(í™”ë©´ì€ ê³„ì† í‘œì‹œ)
        pass

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì•„ì´í…œ ëª©ë¡
#   - ì„œë²„ì˜ PRICING(ì‹ ë¢° ê°€ê²©í‘œ)ê³¼ "code/price"ê°€ ë°˜ë“œì‹œ ê°™ì•„ì•¼ í•¨
#   - desc(ì„¤ëª…)ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ëŠ” ì•ˆë‚´ ë¬¸êµ¬
#   - RNG ë³´ìƒ ë‚´ìš©ì€ ì„œë²„ RNG_TABLEê³¼ ì¼ì¹˜í•˜ëŠ” ê°’ìœ¼ë¡œ ì•ˆë‚´(í˜¼ë™ ë°©ì§€)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ITEMS = [
    
    # {
    #     "key": "ad_cooldown_reset",             # UIìš© ê³ ìœ  í‚¤(ë²„íŠ¼ í‚¤ ë“±)
    #     "code": "AD_COOLDOWN_RESET",            # ì„œë²„ ê²€ì¦ ì½”ë“œ(PRICINGì˜ í‚¤)
    #     "name": "ê´‘ê³  ì¿¨ë‹¤ìš´ ì´ˆê¸°í™”",             # í™”ë©´ í‘œì‹œ ì´ë¦„
    #     "price": 1,                             # ì„œë²„ ê°€ê²©í‘œì™€ ë™ì¼í•´ì•¼ í•¨
    #     "desc": "ê´‘ê³  ë³´ê¸° ëŒ€ê¸°ì‹œê°„ì„ ì¦‰ì‹œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."  # ì„¤ëª…
    # },
    # {
    #     "key": "game_cooldown_skip",
    #     "code": "GAME_COOLDOWN_SKIP",
    #     "name": "ê²Œì„ ì¬ë„ì „ íŒ¨ìŠ¤",
    #     "price": 5,
    #     "desc": "ê²Œì„ ì¿¨ë‹¤ìš´ ìƒíƒœë¥¼ ì¦‰ì‹œ í•´ì œí•©ë‹ˆë‹¤."
    # },
    
# ì¸ê²Œì„ ì•„ì´í…œ
    {
        "key": "rng_box_small",
        "code": "RNG_BOX_SMALL",
        "name": "ëœë¤ í¬ì¸íŠ¸ ìƒì(ì†Œ)",
        "price": 20,
        "desc": "í™•ë¥ ì  ë³´ìƒ (0, 8, 20, 25, 100P ì¤‘ í•˜ë‚˜)",
    },
    {
        "key": "rng_box_big",
        "code": "RNG_BOX_BIG",
        "name": "ëœë¤ í¬ì¸íŠ¸ ìƒì(ëŒ€)",
        "price": 50,
        "desc": "í™•ë¥ ì  ë³´ìƒ (0, 20, 50, 65, 250P ì¤‘ í•˜ë‚˜)",
    },

# ì‹¤ì œ ìƒí’ˆ
    {
        "key": "coffee_americano",
        "code": "COFFEE_AMERICANO",
        "name": "ì•„ë©”ë¦¬ì¹´ë…¸ (ì˜ˆì •)",
        "price": 180,
        "desc": "ì•„ë©”ë¦¬ì¹´ë…¸ ê¸°í”„íŠ¸ì¿ í°. ì§€ê¸ˆì€ ë¯¸ë¦¬ë³´ê¸°ë§Œ ì œê³µë¼ìš”.",
        "img": "https://image.homeplus.kr/td/ed6b7ce1-031f-45f2-a8ee-86fa781aa1e0",  
        "sellable": True
    },
    {
        "key": "coffee_latte",
        "code": "COFFEE_LATTE",
        "name": "ì¹´í˜ë¼ë–¼ (ì˜ˆì •)",
        "price": 200,
        "desc": "ì¹´í˜ë¼ë–¼ ê¸°í”„íŠ¸ì¿ í°. ì§€ê¸ˆì€ ë¯¸ë¦¬ë³´ê¸°ë§Œ ì œê³µë¼ìš”.",
        "img": "https://image.homeplus.kr/td/ad42d3de-ea74-4b95-b612-2267d50da108",
        "sellable": True
    },
    {
        "key": "icecream_cone",
        "code": "ICECREAM_CONE",
        "name": "ì•„ì´ìŠ¤í¬ë¦¼ ì½˜ (ì˜ˆì •)",
        "price": 150,
        "desc": "ì•„ì´ìŠ¤í¬ë¦¼ ê¸°í”„íŠ¸ì¿ í°. ì§€ê¸ˆì€ ë¯¸ë¦¬ë³´ê¸°ë§Œ ì œê³µë¼ìš”.",
        "img": "https://image.homeplus.kr/td/e7bf9658-6132-4947-a818-fe2a8504c3d2",
        "sellable": False
    },
    {
        "key": "sandwich_basic",
        "code": "SANDWICH_BASIC",
        "name": "ìƒŒë“œìœ„ì¹˜ (ì˜ˆì •)",
        "price": 250,
        "desc": "ìƒŒë“œìœ„ì¹˜ ê¸°í”„íŠ¸ì¿ í°. ì§€ê¸ˆì€ ë¯¸ë¦¬ë³´ê¸°ë§Œ ì œê³µë¼ìš”.",
        "img": "https://image.homeplus.kr/td/111e0e48-4471-46ba-9040-1f79e6057b4b",
        "sellable": False
    }
    ]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# êµ¬ë§¤ HTTP í˜¸ì¶œ
#   - ì„œë²„: POST /shop/purchase
#   - payload: user_id, item_code, item_name, price
#   - ì„œë²„ëŠ” "ë¨¼ì € ì°¨ê°" í›„, RNG ì•„ì´í…œì´ë©´ "ë³´ìƒ ì§€ê¸‰"ê¹Œì§€ ì²˜ë¦¬
#   - ì„±ê³µ ì‹œ ì‘ë‹µ: {"ok": True, "total_point": ìµœì¢…í¬ì¸íŠ¸, "rng_gain": ë³´ìƒ(ì—†ìœ¼ë©´ 0)}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _purchase(user_id: str, code: str, name: str, price: int):
    try:
        # ìš”ì²­ ë°”ë””(JSON)
        payload = {
            "user_id": user_id,
            "item_code": code,
            "item_name": name,   # í‘œì‹œìš©(ì„œë²„ ê²€ì¦ì—ëŠ” ì˜í–¥ ì—†ìŒ)
            "price": price       # ì„œë²„ PRICINGê³¼ ê°™ì•„ì•¼ í†µê³¼
        }

        # ì„œë²„ë¡œ POST (íƒ€ì„ì•„ì›ƒ ìƒìˆ˜ ì ìš©)
        r = requests.post(f"{FASTAPI_ENDPOINT}/shop/purchase", json=payload, timeout=TIMEOUT_S)

        # ì‘ë‹µ JSON íŒŒì‹±(ì„œë²„ê°€ JSONì„ ë³´ë‚¸ë‹¤ëŠ” ì „ì œ)
        data = r.json()

        # HTTP 200 + ok=True ì´ë©´ ì„±ê³µ
        if r.status_code == 200 and data.get("ok"):
            # ì„œë²„ê°€ ë‚´ë ¤ì¤€ "ìµœì¢… í¬ì¸íŠ¸"ë¥¼ ê·¸ëŒ€ë¡œ ì„¸ì…˜ì— ì €ì¥
            #  - í”„ë¡ íŠ¸ì—ì„œ ì§ì ‘ í¬ì¸íŠ¸ë¥¼ ë”/ë¹¼ì§€ ì•ŠìŒ(ë¶ˆì¼ì¹˜ ë°©ì§€)
            if "total_point" in data:
                st.session_state.points = data["total_point"]
            return True, None, data  # (ì„±ê³µ, ì˜¤ë¥˜ë©”ì‹œì§€ì—†ìŒ, ì„œë²„ì‘ë‹µ)

        # ì‹¤íŒ¨(HTTP 200ì´ ì•„ë‹ˆê±°ë‚˜ ok=False) â†’ ì„œë²„ì˜ detail/í…ìŠ¤íŠ¸ ë…¸ì¶œ
        detail = ""
        try:
            detail = data.get("detail", "")
        except Exception:
            detail = r.text
        return False, detail or f"êµ¬ë§¤ ì‹¤íŒ¨ (HTTP {r.status_code})", None

    except requests.exceptions.RequestException as e:
        # ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(ì—°ê²°/íƒ€ì„ì•„ì›ƒ ë“±)
        return False, f"ì„œë²„ í†µì‹  ì˜¤ë¥˜: {e}", None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íš¨ê³¼ ì ìš© (í”„ë¡ íŠ¸ í‘œì‹œ ì „ìš©)
#   - í¬ì¸íŠ¸ ë³€ê²½ì€ ì´ë¯¸ ì„œë²„ì—ì„œ ë°˜ì˜ë¨(í”„ë¡ íŠ¸ëŠ” ë©”ì‹œì§€/ì• ë‹ˆë©”ì´ì…˜ë§Œ)
#   - RNG: ë³´ìƒ ê¸ˆì•¡ ì•ˆë‚´
#   - ê¸°ëŠ¥í˜•: ì¿¨ë‹¤ìš´/ê²Œì„ ìƒíƒœ ë³€ê²½(í”„ë¡ íŠ¸ ì„¸ì…˜ ê°’)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _apply_visual_effect(item_code: str, resp: dict | None):
    # RNG ì•„ì´í…œ: ì„œë²„ê°€ ë‚´ë ¤ì¤€ ë³´ìƒê°’ í‘œì‹œ
    if item_code == "RNG_BOX_SMALL" or item_code == "RNG_BOX_BIG":
        gain = (resp or {}).get("rng_gain", 0)  # ë³´ìƒ ê¸ˆì•¡(ì—†ìœ¼ë©´ 0)
        if gain > 0:
            st.balloons()                       # í’ì„  ì• ë‹ˆë©”ì´ì…˜
            st.success(f"ğŸ ë³´ìƒ +{gain}P ì§€ê¸‰ ì™„ë£Œ!")
        else:
            st.info("ğŸ˜µâ€ğŸ’« ê½! ë³´ìƒ 0P")
        return
"""
    # ê¸°ëŠ¥í˜• ì•„ì´í…œ: í”„ë¡ íŠ¸ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
    if item_code == "AD_COOLDOWN_RESET":
        st.session_state.last_ad_watch_time = None     # ê´‘ê³  ë§ˆì§€ë§‰ ì‹œê° ì´ˆê¸°í™”
        st.session_state.ad_cooldown_active = False    # ì¿¨ë‹¤ìš´ í•´ì œ
        st.success("âœ… ê´‘ê³  ì¿¨ë‹¤ìš´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!")
    elif item_code == "GAME_COOLDOWN_SKIP":
        if st.session_state.game_state == "cooldown":
            st.session_state.game_state = "initial"    # ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            st.session_state.game_cooldown_start_time = None
            st.info("ğŸ” ê²Œì„ ì¿¨ë‹¤ìš´ì„ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì¬ë„ì „ ê°€ëŠ¥!")
"""
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª¨ë‹¬(ëŒ€í™”ìƒì) UI
#   - @st.dialog: Streamlit ì œê³µ íŒì—… ì»´í¬ë„ŒíŠ¸
#   - 'êµ¬ë§¤í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ì´ ëª¨ë‹¬ì„ ë„ì›Œ ìµœì¢… í™•ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.dialog("êµ¬ë§¤ í™•ì¸")
def confirm_purchase_dialog(item, user_points: int):
    # êµ¬ë§¤ ì •ë³´ ìš”ì•½
    st.write(f"ìƒí’ˆ: **{item['name']}**")
    st.write(f"ê°€ê²©: **{item['price']}P**")
    st.write(f"ë³´ìœ  í¬ì¸íŠ¸: **{user_points}P**")

    # ë‘ ê°œì˜ ì»¬ëŸ¼(í™•ì¸/ì·¨ì†Œ ë²„íŠ¼)
    c1, c2 = st.columns(2)

    # ì™¼ìª½: "ì˜ˆ, êµ¬ë§¤" ë²„íŠ¼
    with c1:
        # use_container_width=True : ë²„íŠ¼ ë„ˆë¹„ë¥¼ ì»¬ëŸ¼ ë„ˆë¹„ì— ë§ì¶¤
        if st.button("ì˜ˆ, êµ¬ë§¤í• ê²Œìš” âœ…", use_container_width=True, key=f"confirm_yes_{item['key']}", disabled=st.session_state.buying):
            # ì¤‘ë³µ í´ë¦­ ë°©ì§€: êµ¬ë§¤ ì‹œì‘ â†’ buying=True
            st.session_state.buying = True
            # ì„œë²„ë¡œ êµ¬ë§¤ ìš”ì²­
            ok, err, resp = _purchase(st.session_state.user_id, item["code"], item["name"], item["price"])
            if ok:
                # ì‹œê° íš¨ê³¼(ë©”ì‹œì§€/í’ì„ ). í¬ì¸íŠ¸ëŠ” ì´ë¯¸ ì„œë²„ ì‘ë‹µìœ¼ë¡œ ë™ê¸°í™”ë¨
                _apply_visual_effect(item["code"], resp)
                st.success(f"êµ¬ë§¤ ì™„ë£Œ! ë‚¨ì€ í¬ì¸íŠ¸: {st.session_state.points}P")
            else:
                # ì‹¤íŒ¨ ì‚¬ìœ  ì•ˆë‚´
                st.error(err or "êµ¬ë§¤ ì‹¤íŒ¨")
            # êµ¬ë§¤ ì¢…ë£Œ â†’ buying=False
            st.session_state.buying = False
            # ëª¨ë‹¬ ë‹«ê³  í™”ë©´ ê°±ì‹ 
            st.rerun()

    # ì˜¤ë¥¸ìª½: "ì·¨ì†Œ" ë²„íŠ¼
    with c2:
        if st.button("ì•„ë‹ˆìš”, ì·¨ì†Œ", use_container_width=True, key=f"confirm_no_{item['key']}"):
            st.info("êµ¬ë§¤ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸ í˜ì´ì§€ í•¨ìˆ˜(ì—”íŠ¸ë¦¬)
#   - ì‚¬ì´ë“œë°”/ë¼ìš°íŒ…ì—ì„œ shop_page()ë¥¼ í˜¸ì¶œ
#   - ì„¸ì…˜ ì´ˆê¸°í™” â†’ ë¡œê·¸ì¸ í™•ì¸ â†’ í¬ì¸íŠ¸ ë™ê¸°í™” â†’ ì•„ì´í…œ ì¹´ë“œ ë Œë”ë§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def shop_page():
    # 1) ì„¸ì…˜ ê¸°ë³¸ê°’ ë³´ì¥
    _ensure_session_defaults()

    # 2) ì œëª©
    st.title("ğŸ›’ ì•„ì´í…œ ìƒì ")

    # 3) ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ (user_idê°€ ë¹„ì–´ ìˆìœ¼ë©´ ê²½ê³ )
    if not st.session_state.get("user_id"):
        st.warning("êµ¬ë§¤í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.")
        return  # ë¡œê·¸ì¸ ì „ì—ëŠ” ìƒì  ê¸°ëŠ¥ ë¹„í™œì„±

    # 4) í˜ì´ì§€ ì§„ì… ì‹œ ì„œë²„ í¬ì¸íŠ¸ ë™ê¸°í™”(í‘œì‹œê°’ ì‹ ë¢°ì„± â†‘)
    _sync_points_from_server(st.session_state.user_id)

    # 5) í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸ í‘œì‹œ
    st.markdown(f"**ë³´ìœ  í¬ì¸íŠ¸:** {st.session_state.points}P")

    # (ì˜µì…˜) ê³µì§€/ì •ì±… ì•ˆë‚´: í™•ë¥ í˜• ë³´ìƒ êµ¬ì¡°ë¥¼ ì„¤ëª…í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì— st.info()ë¡œ í‘œê¸° ê°€ëŠ¥
    # st.info("í™•ë¥ í˜• ë³´ìƒ(ëœë¤ ë°•ìŠ¤)ì˜ ìƒì„¸ í™•ë¥ ì€ ì•ˆë‚´ í˜ì´ì§€ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.")

    # 6) ì•„ì´í…œ ì¹´ë“œ(2ì—´) ë Œë”ë§
    # 2ì—´ ì¹´ë“œ UI
    cols = st.columns(2)
    for idx, item in enumerate(ITEMS):
        with cols[idx % 2]:
            box = st.container(border=True)
            with box:
                img = (item.get("img") or "").strip()
                if img:
                    c1, c2, c3 = st.columns([1, 2, 1])
                    with c2:
                        st.image(img, width=250)

                st.markdown(
                    f"""
                    <div style="margin-top:8px; text-align: center;">
                        <div style="font-weight:600; font-size:18px; margin-bottom:6px;">{item['name']}</div>
                        <div style="color:#666; font-size:14px; margin-bottom:10px;">{item['desc']}</div>
                        <div style="font-weight:700; margin-bottom:10px;">{item['price']}P</div>
                    </div>
                    """,
                    unsafe_allow_html=True
                )

                # --- ë²„íŠ¼ í™œì„±/ë¹„í™œì„± íŒì • ---
                sellable = item.get("sellable", True)  # ê¸°ë³¸ True(ëœë¤ë°•ìŠ¤ëŠ” êµ¬ë§¤ ê°€ëŠ¥), ì‹¤ì œìƒí’ˆì€ False
                lack_point = st.session_state.points < item["price"]
                buying_now = st.session_state.buying

                # ë¼ë²¨/ë¹„í™œì„± ì‚¬ìœ  ìš°ì„ ìˆœìœ„: ê³§ ì˜¤í”ˆ > í¬ì¸íŠ¸ ë¶€ì¡± > êµ¬ë§¤ ì¤‘
                if not sellable:
                    label = "ê³§ ì˜¤í”ˆ! ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”"
                    disabled = True
                elif lack_point:
                    label = "í¬ì¸íŠ¸ ë¶€ì¡±"
                    disabled = True
                else:
                    label = "êµ¬ë§¤í•˜ê¸°"
                    disabled = buying_now

                if st.button(label, key=f"buy_{item['key']}", use_container_width=True, disabled=disabled):
                    # íŒë§¤ ë¶ˆê°€(ê³§ ì˜¤í”ˆ)ì€ ëˆŒëŸ¬ë„ ì•„ë¬´ ì‘ì—… ì•ˆí•¨
                    if not sellable:
                        st.info("ì´ ìƒí’ˆì€ ê³§ ì˜¤í”ˆë©ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!")
                    else:
                        # ê¸°ì¡´ êµ¬ë§¤ íë¦„ ìœ ì§€
                        confirm_purchase_dialog(item, st.session_state.points)

